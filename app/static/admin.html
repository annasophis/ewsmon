<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EWS Monitoring — Admin</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #111833;
      --line: rgba(255,255,255,.08);
      --text: #e8ecff;
      --muted: #a9b2d6;
      --ok: #31d07f;
      --bad: #ff4d5e;
      --warn: #ffcc66;
      --accent: rgba(124,156,255,.5);
      --space-xs: 6px;
      --space-sm: 12px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;
      --radius: 12px;
      --radius-sm: 8px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(180deg, #070a14 0%, var(--bg) 100%);
      color: var(--text);
      font-size: 15px;
      line-height: 1.5;
    }

    /* Dashboard layout */
    .admin-header {
      padding: var(--space-lg) var(--space-xl);
      border-bottom: 1px solid var(--line);
      background: rgba(7,10,20,.7);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: var(--space-md);
    }
    .admin-header h1 {
      margin: 0 0 var(--space-xs);
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -.02em;
    }
    .admin-header .subtitle {
      color: var(--muted);
      font-size: 0.875rem;
    }
    .admin-header .subtitle code {
      background: rgba(255,255,255,.08);
      padding: 2px 8px;
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
    }
    .admin-wrap {
      max-width: 1000px;
      margin: 0 auto;
      padding: var(--space-xl);
    }

    /* Card containers */
    .card {
      background: linear-gradient(180deg, rgba(17,24,51,.95) 0%, rgba(15,22,48,.85) 100%);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: var(--space-lg);
    }
    .card:last-child { margin-bottom: 0; }
    .card-header {
      padding: var(--space-md) var(--space-lg);
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: var(--space-sm);
    }
    .card-title {
      margin: 0;
      font-size: 1.0625rem;
      font-weight: 700;
    }
    .card-desc {
      color: var(--muted);
      font-size: 0.8125rem;
      margin: 0;
      width: 100%;
    }
    .card-body {
      padding: var(--space-lg);
    }
    .card-body .form-group + .form-group { margin-top: var(--space-md); }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-lg);
    }
    @media (max-width: 720px) { .row { grid-template-columns: 1fr; } }

    /* Form elements */
    .form-group label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--muted);
      margin-bottom: var(--space-xs);
    }
    .form-group input[type="checkbox"] {
      margin-right: var(--space-sm);
      vertical-align: middle;
    }
    .form-group input[type="text"],
    .form-group input[type="password"],
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-sm);
      border: 1px solid var(--line);
      background: rgba(25,34,72,.4);
      color: var(--text);
      font-size: 0.9375rem;
    }
    .form-group input::placeholder,
    .form-group textarea::placeholder { color: var(--muted); opacity: .8; }
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(124,156,255,.15);
    }
    .form-group select { cursor: pointer; }
    .form-group textarea { min-height: 96px; resize: vertical; }

    /* Buttons */
    .btn-group { display: flex; gap: var(--space-sm); margin-top: var(--space-md); flex-wrap: wrap; }
    .btn {
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-sm);
      border: 1px solid var(--line);
      font-weight: 600;
      font-size: 0.8125rem;
      cursor: pointer;
      transition: background .15s;
    }
    .btn-primary {
      background: rgba(25,34,72,.85);
      color: var(--text);
    }
    .btn-primary:hover { background: rgba(25,34,72,.95); }
    .btn-secondary {
      background: rgba(25,34,72,.4);
      color: var(--text);
    }
    .btn-secondary:hover { background: rgba(25,34,72,.6); }
    .btn-danger {
      background: rgba(255,77,94,.2);
      border-color: var(--bad);
      color: #ff8a94;
    }
    .btn-danger:hover { background: rgba(255,77,94,.3); }
    .btn-sm { padding: 6px 10px; font-size: 0.75rem; }

    /* Pills */
    .pill {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      border: 1px solid var(--line);
      background: rgba(25,34,72,.35);
    }
    .pill.ok { background: rgba(49,208,127,.15); border-color: var(--ok); color: var(--ok); }
    .pill.bad { background: rgba(255,77,94,.15); border-color: var(--bad); color: var(--bad); }

    /* Preview areas */
    .preview-box {
      margin-top: var(--space-md);
      padding: var(--space-md) var(--space-lg);
      border-radius: var(--radius-sm);
      border: 1px solid var(--line);
      background: rgba(0,0,0,.2);
    }
    .preview-label {
      font-size: 0.6875rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .06em;
      margin-bottom: var(--space-sm);
    }
    .banner-preview {
      white-space: pre-wrap;
      word-break: break-word;
      font-weight: 600;
      font-size: 0.9375rem;
    }
    .banner-preview.empty { color: var(--muted); font-style: italic; font-weight: normal; }

    /* Styled table (notes) */
    .table-wrap { overflow-x: auto; margin-top: var(--space-sm); }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    .admin-table th,
    .admin-table td {
      padding: var(--space-sm) var(--space-md);
      text-align: left;
      border-bottom: 1px solid var(--line);
    }
    .admin-table th {
      font-size: 0.6875rem;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .05em;
    }
    .admin-table tbody tr:last-child td { border-bottom: 0; }
    .admin-table tbody tr:hover { background: rgba(255,255,255,.02); }
    .admin-table .cell-title { font-weight: 600; color: var(--text); }
    .admin-table .cell-body { color: var(--muted); word-break: break-word; max-width: 320px; }
    .admin-table .cell-date { font-size: 0.75rem; color: var(--muted); white-space: nowrap; }
    .notes-empty { color: var(--muted); font-style: italic; font-size: 0.875rem; padding: var(--space-md); }

    /* Toasts */
    .toast-container {
      position: fixed;
      bottom: var(--space-lg);
      right: var(--space-lg);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      max-width: 360px;
    }
    .toast {
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-sm);
      border: 1px solid var(--line);
      background: var(--panel);
      color: var(--text);
      font-size: 0.875rem;
      box-shadow: 0 4px 12px rgba(0,0,0,.4);
      animation: toastIn 0.2s ease-out;
    }
    .toast.success { border-color: var(--ok); background: rgba(49,208,127,.12); }
    .toast.error { border-color: var(--bad); background: rgba(255,77,94,.12); }
    .toast.info { border-color: var(--accent); background: rgba(124,156,255,.1); }
    @keyframes toastIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    /* Confirm modal */
    .confirm-overlay {
      position: fixed; inset: 0; z-index: 10000;
      background: rgba(0,0,0,.6); backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center;
      padding: var(--space-lg);
    }
    .confirm-modal {
      background: var(--panel); border: 1px solid var(--line);
      border-radius: var(--radius); padding: var(--space-lg);
      max-width: 400px; width: 100%;
    }
    .confirm-modal p { margin: 0 0 var(--space-lg); color: var(--text); }
    .confirm-modal .btn-group { margin-bottom: 0; }
  </style>
</head>

<body>
  <div id="toastContainer" class="toast-container" aria-live="polite"></div>

  <header class="admin-header">
    <div>
      <h1>EWS Monitoring — Admin</h1>
      <p class="subtitle">Manage banner, notes, and incident updates.</p>
    </div>
    <button type="button" id="logoutBtn" class="btn btn-secondary">Log out</button>
  </header>

  <main class="admin-wrap">
    <div class="row">
      <section class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">Banner</h2>
            <p class="card-desc">Site-wide notice shown on the dashboard. Line breaks are preserved.</p>
          </div>
          <div id="bannerStatus" class="pill">Loading…</div>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label>
              <input type="checkbox" id="bannerEnabled" />
              Enabled
            </label>
          </div>
          <div class="form-group">
            <label for="bannerType">Type</label>
            <select id="bannerType">
              <option value="info">info</option>
              <option value="maintenance">maintenance</option>
              <option value="warning">warning</option>
              <option value="incident">incident</option>
            </select>
          </div>
          <div class="form-group">
            <label for="bannerMessage">Message</label>
            <textarea id="bannerMessage" placeholder="Planned maintenance Sunday 2:00–3:00 AM ET"></textarea>
          </div>
          <div class="form-group">
            <label for="bannerStartsAt">Starts at (ISO, optional)</label>
            <input id="bannerStartsAt" type="text" placeholder="2026-02-23T02:00:00-05:00">
          </div>
          <div class="form-group">
            <label for="bannerEndsAt">Ends at (ISO, optional)</label>
            <input id="bannerEndsAt" type="text" placeholder="2026-02-23T03:00:00-05:00">
          </div>
          <div class="btn-group">
            <button id="saveBannerBtn" class="btn btn-primary">Save banner</button>
            <button id="disableBannerBtn" class="btn btn-danger" type="button">Disable banner</button>
            <button id="reloadBannerBtn" class="btn btn-secondary" type="button">Reload</button>
          </div>
          <div class="preview-box">
            <div class="preview-label">Preview (as shown on dashboard)</div>
            <div id="bannerPreview" class="banner-preview empty">No message yet.</div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">Per-API Notes</h2>
            <p class="card-desc">Pick a target, add a note, then preview in the table below.</p>
          </div>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label for="targetSelect">Target</label>
            <select id="targetSelect"></select>
          </div>
          <div class="form-group">
            <label for="noteTitle">Title</label>
            <input id="noteTitle" type="text" placeholder="Maintenance window" />
          </div>
          <div class="form-group">
            <label for="noteBody">Body</label>
            <textarea id="noteBody" placeholder="Planned maintenance Sunday 2–3 AM ET. Some requests may time out."></textarea>
          </div>
          <div class="btn-group">
            <button id="addNoteBtn" class="btn btn-primary">Add note</button>
            <button id="previewNotesBtn" class="btn btn-secondary" type="button">Preview notes</button>
            <button id="reloadTargetsBtn" class="btn btn-secondary" type="button">Reload targets</button>
          </div>
          <div class="preview-box">
            <div class="preview-label">Notes for selected target</div>
            <div id="notesPreview" class="table-wrap">
              <span class="notes-empty">Select a target and click Preview notes.</span>
            </div>
          </div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top: var(--space-lg);">
      <div class="card-header">
        <div>
          <h2 class="card-title">Incident Updates</h2>
          <p class="card-desc">Create manual incident updates shown on the public dashboard.</p>
        </div>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label for="incidentStatus">Status</label>
          <select id="incidentStatus">
            <option value="investigating">investigating</option>
            <option value="identified">identified</option>
            <option value="monitoring">monitoring</option>
            <option value="maintenance">maintenance</option>
            <option value="resolved">resolved</option>
          </select>
        </div>
        <div class="form-group">
          <label for="incidentTitle">Title</label>
          <input id="incidentTitle" type="text" placeholder="e.g. Degraded EWS response times" />
        </div>
        <div class="form-group">
          <label for="incidentAffectedService">Affected service (optional)</label>
          <input id="incidentAffectedService" type="text" placeholder="e.g. EWS Validate API" />
        </div>
        <div class="form-group">
          <label for="incidentMessage">Message</label>
          <textarea id="incidentMessage" placeholder="Describe the incident and any mitigation steps. Line breaks are preserved." rows="3"></textarea>
        </div>
        <div class="btn-group">
          <button id="incidentSubmitBtn" class="btn btn-primary">Create incident</button>
          <button id="incidentReloadBtn" class="btn btn-secondary" type="button">Reload list</button>
        </div>
        <div class="preview-box" style="margin-top: var(--space-md);">
          <div class="preview-label">Add update to active incident</div>
          <div style="display: flex; flex-wrap: wrap; gap: var(--space-md); align-items: flex-end; margin-top: 8px;">
            <div class="form-group" style="margin-bottom: 0; min-width: 180px;">
              <label for="incidentSelectForUpdate">Incident</label>
              <select id="incidentSelectForUpdate"><option value="">— Select —</option></select>
            </div>
            <div class="form-group" style="margin-bottom: 0; min-width: 140px;">
              <label for="updateStatus">Status</label>
              <select id="updateStatus">
                <option value="investigating">investigating</option>
                <option value="identified">identified</option>
                <option value="monitoring">monitoring</option>
                <option value="maintenance">maintenance</option>
                <option value="resolved">resolved</option>
              </select>
            </div>
            <div class="form-group" style="flex: 1; margin-bottom: 0; min-width: 160px;">
              <label for="updateMessage">Message</label>
              <input id="updateMessage" type="text" placeholder="Status update message" />
            </div>
            <button id="addUpdateBtn" class="btn btn-primary" type="button">Add update</button>
          </div>
        </div>
        <div class="preview-box" style="margin-top: var(--space-md);">
          <div class="preview-label">Recent incidents (roots). Resolve closes the incident and moves it to Incident History.</div>
          <div id="incidentList" class="table-wrap">
            <span class="notes-empty">Click Reload list to load.</span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const API = {
      SUMMARY_GET: "/api/summary",
      NOTICES_GET: "/api/notices",
      BANNER_PUT: "/api/admin/notices/banner",
      NOTE_ADD_POST: (id) => `/api/admin/targets/${encodeURIComponent(id)}/notes`,
      NOTES_GET: (id) => `/api/targets/${encodeURIComponent(id)}/notes`,
      INCIDENTS_GET: "/api/incidents",
      INCIDENTS_POST: "/api/incidents",
      INCIDENT_ADD_UPDATE: (id) => `/api/incidents/${encodeURIComponent(id)}/updates`,
      INCIDENT_RESOLVE: (id) => `/api/incidents/${encodeURIComponent(id)}/resolve`,
    };

    function $(id){ return document.getElementById(id); }

    const SESSION_KEY = "ewsmon_admin_token";
    function getSessionToken(){ return localStorage.getItem(SESSION_KEY) || ""; }
    function clearSession(){ localStorage.removeItem(SESSION_KEY); }

    function toast(message, type = "success"){
      const container = $("toastContainer");
      const el = document.createElement("div");
      el.className = "toast " + (type === "error" ? "error" : type === "info" ? "info" : "success");
      el.setAttribute("role", "alert");
      el.textContent = message;
      container.appendChild(el);
      setTimeout(() => el.remove(), 4000);
    }

    function showConfirm(message){
      return new Promise((resolve) => {
        const overlay = document.createElement("div");
        overlay.className = "confirm-overlay";
        overlay.innerHTML = `
          <div class="confirm-modal">
            <p>${message.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>
            <div class="btn-group">
              <button type="button" class="btn btn-primary" data-result="yes">Confirm</button>
              <button type="button" class="btn btn-secondary" data-result="no">Cancel</button>
            </div>
          </div>`;
        const remove = () => { overlay.remove(); };
        overlay.querySelector("[data-result=yes]").addEventListener("click", () => { remove(); resolve(true); });
        overlay.querySelector("[data-result=no]").addEventListener("click", () => { remove(); resolve(false); });
        overlay.addEventListener("click", (e) => { if (e.target === overlay) { remove(); resolve(false); } });
        document.body.appendChild(overlay);
      });
    }

    async function fetchJson(url, opts={}){
      const token = getSessionToken();
      const headers = {
        "Accept": "application/json",
        ...(token ? { "Authorization": "Bearer " + token } : {}),
        ...(opts.headers || {})
      };
      const res = await fetch(url, { cache: "no-store", headers, ...opts });
      if (res.status === 401) {
        clearSession();
        window.location.href = "/login";
        throw new Error("Session expired");
      }
      if (!res.ok){
        const txt = await res.text().catch(() => "");
        throw new Error(`${url} -> ${res.status} ${txt}`);
      }
      return await res.json();
    }

    function adminHeaders(extra={}){
      const token = getSessionToken();
      return {
        "Authorization": token ? "Bearer " + token : "",
        ...extra
      };
    }
    function incidentHeaders(extra={}){
      const token = getSessionToken();
      return {
        "Content-Type": "application/json",
        "Authorization": token ? "Bearer " + token : "",
        ...extra
      };
    }

    function setPill(el, text, kind){
      el.textContent = text;
      el.className = "pill " + (kind || "");
    }

    // ---------- Targets ----------
    async function loadTargets(){
      const sel = $("targetSelect");
      sel.innerHTML = `<option>Loading…</option>`;
      const data = await fetchJson(API.SUMMARY_GET);
      const items = Array.isArray(data) ? data : (data.items || []);

      const mapped = items.map(it => ({
        id: it.id ?? it.target_id ?? it.targetId ?? it.service_id,
        name: it.name ?? it.service ?? it.service_name ?? "—"
      })).filter(x => x.id !== undefined && x.id !== null);

      sel.innerHTML = mapped.length
        ? mapped.map(x => `<option value="${String(x.id)}">${String(x.name)} (id: ${String(x.id)})</option>`).join("")
        : `<option value="">No targets found (summary missing id)</option>`;
    }

    // ---------- Banner ----------
    function updateBannerPreview(){
      const msg = $("bannerMessage").value.trim();
      const el = $("bannerPreview");
      el.textContent = msg || "";
      el.classList.toggle("empty", !msg);
      if (!msg) el.textContent = "No message yet.";
    }

    async function loadBanner(){
      const raw = await fetchJson(API.NOTICES_GET).catch(() => null);
      const b = raw?.banner || null;
      if (!b){
        setPill($("bannerStatus"), "No banner object found", "bad");
        $("bannerPreview").textContent = "No message yet.";
        $("bannerPreview").classList.add("empty");
        return;
      }

      $("bannerEnabled").checked = !!b.enabled;
      $("bannerType").value = b.type || "info";
      $("bannerMessage").value = b.message || "";
      $("bannerStartsAt").value = b.starts_at || "";
      $("bannerEndsAt").value = b.ends_at || "";

      setPill($("bannerStatus"), b.enabled ? `Enabled (${b.type || "info"})` : "Disabled", b.enabled ? "ok" : "");
      const el = $("bannerPreview");
      el.textContent = b.message || "";
      el.classList.toggle("empty", !b.message);
      if (!b.message) el.textContent = "No message yet.";
    }

    async function saveBanner(enabledOverride=null){
      const enabled = (enabledOverride !== null) ? enabledOverride : $("bannerEnabled").checked;

      const payload = {
        enabled,
        notice_type: $("bannerType").value,
        message: $("bannerMessage").value,
        starts_at: $("bannerStartsAt").value || null,
        ends_at: $("bannerEndsAt").value || null
      };

      await fetchJson(API.BANNER_PUT, {
        method: "PUT",
        headers: adminHeaders({ "Content-Type":"application/json" }),
        body: JSON.stringify(payload)
      });

      await loadBanner();
      toast(enabled ? "Banner saved" : "Banner disabled");
    }

    $("bannerMessage").addEventListener("input", updateBannerPreview);

    // ---------- Notes ----------
    async function addNote(){
      const targetId = $("targetSelect").value;
      if (!targetId){
        toast("Select a target first.", "error");
        return;
      }

      const title = $("noteTitle").value.trim();
      const body = $("noteBody").value.trim();
      if (!title || !body){
        toast("Title and body are required.", "error");
        return;
      }

      const payload = { title, body };

      await fetchJson(API.NOTE_ADD_POST(targetId), {
        method: "POST",
        headers: adminHeaders({ "Content-Type":"application/json" }),
        body: JSON.stringify(payload)
      });

      $("noteTitle").value = "";
      $("noteBody").value = "";
      toast("Note added");
      await previewNotes();
    }

    function escapeHtml(s){
      const t = document.createTextNode(String(s ?? ""));
      const div = document.createElement("div");
      div.appendChild(t);
      return div.innerHTML;
    }

    async function previewNotes(){
      const container = $("notesPreview");
      const targetId = $("targetSelect").value;
      if (!targetId){
        container.innerHTML = "<span class=\"notes-empty\">Select a target and click Preview notes.</span>";
        return;
      }
      const data = await fetchJson(API.NOTES_GET(targetId));
      const items = data?.items ?? (Array.isArray(data) ? data : []);
      if (!items.length){
        container.innerHTML = "<span class=\"notes-empty\">No notes for this target.</span>";
        return;
      }
      const rows = items.map(n => {
        const title = escapeHtml(n.title ?? "");
        const body = escapeHtml(n.body ?? n.note ?? "").replace(/\n/g, " ");
        const date = n.created_at ? new Date(n.created_at).toLocaleString() : "";
        return `<tr><td class="cell-title">${title}</td><td class="cell-body">${body}</td><td class="cell-date">${escapeHtml(date)}</td></tr>`;
      }).join("");
      container.innerHTML = `<table class="admin-table"><thead><tr><th>Title</th><th>Body</th><th>Date</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    // ---------- Incident Updates ----------
    async function loadIncidentList(){
      const container = $("incidentList");
      const selectForUpdate = $("incidentSelectForUpdate");
      try {
        const data = await fetchJson(API.INCIDENTS_GET + "?limit=50");
        const items = data.items || [];
        const activeItems = items.filter(it => it.is_active);
        if (selectForUpdate) {
          selectForUpdate.innerHTML = "<option value=\"\">— Select —</option>" +
            activeItems.map(it => `<option value="${it.id}">#${it.id} ${escapeHtml(it.title || "Incident")}</option>`).join("");
        }
        if (!items.length){
          container.innerHTML = "<span class=\"notes-empty\">No incidents yet.</span>";
          return;
        }
        const rows = items.map(it => {
          const id = it.id;
          const title = escapeHtml(it.title ?? "");
          const msg = escapeHtml((it.message ?? "").replace(/\n/g, " ")).slice(0, 80) + ((it.message || "").length > 80 ? "…" : "");
          const date = it.created_at ? new Date(it.created_at).toLocaleString() : "";
          const status = escapeHtml(it.status || "");
          const affected = escapeHtml(it.affected_service || "—");
          const active = it.is_active ? "<span class=\"pill bad\">Active</span>" : "<span class=\"pill ok\">Resolved</span>";
          const resolveBtn = it.is_active ? `<button type="button" class="btn btn-secondary btn-sm js-resolve-incident" data-id="${id}">Resolve</button>` : "";
          return `<tr><td class="cell-title">${title}</td><td class="cell-body">${msg}</td><td>${affected}</td><td>${status}</td><td>${active}</td><td class="cell-date">${escapeHtml(date)}</td><td>${resolveBtn}</td></tr>`;
        }).join("");
        container.innerHTML = `<table class="admin-table"><thead><tr><th>Title</th><th>Message</th><th>Affected</th><th>Status</th><th>State</th><th>Date</th><th></th></tr></thead><tbody>${rows}</tbody></table>`;
        container.querySelectorAll(".js-resolve-incident").forEach(btn => {
          btn.addEventListener("click", () => resolveIncident(Number(btn.getAttribute("data-id"))));
        });
      } catch (e) {
        container.innerHTML = "<span class=\"notes-empty\">Failed to load: " + escapeHtml(e.message) + "</span>";
      }
    }

    async function createIncident(){
      const status = $("incidentStatus").value.trim();
      const title = $("incidentTitle").value.trim();
      const message = $("incidentMessage").value.trim();
      const affected_service = ($("incidentAffectedService") && $("incidentAffectedService").value.trim()) || null;
      if (!title || !message){
        toast("Title and message are required.", "error");
        return;
      }
      await fetchJson(API.INCIDENTS_POST, {
        method: "POST",
        headers: incidentHeaders(),
        body: JSON.stringify({ status, title, message, is_active: true, affected_service })
      });
      $("incidentTitle").value = "";
      if ($("incidentAffectedService")) $("incidentAffectedService").value = "";
      $("incidentMessage").value = "";
      toast("Incident created");
      await loadIncidentList();
    }

    async function addUpdate(){
      const incidentId = ($("incidentSelectForUpdate") && $("incidentSelectForUpdate").value) || "";
      const status = ($("updateStatus") && $("updateStatus").value) || "";
      const message = ($("updateMessage") && $("updateMessage").value || "").trim();
      if (!incidentId){
        toast("Select an incident.", "error");
        return;
      }
      if (!message){
        toast("Message is required for the update.", "error");
        return;
      }
      await fetchJson(API.INCIDENT_ADD_UPDATE(incidentId), {
        method: "POST",
        headers: incidentHeaders(),
        body: JSON.stringify({ status, message })
      });
      if ($("updateMessage")) $("updateMessage").value = "";
      toast("Update added");
      await loadIncidentList();
    }

    async function resolveIncident(id){
      const ok = await showConfirm("Mark this incident as resolved? It will be hidden from the current banner.");
      if (!ok) return;
      await fetchJson(API.INCIDENT_RESOLVE(id), {
        method: "POST",
        headers: incidentHeaders()
      });
      toast("Incident resolved");
      await loadIncidentList();
    }

    // ---------- Wire up ----------
    $("logoutBtn").addEventListener("click", () => {
      clearSession();
      window.location.href = "/login";
    });

    $("reloadTargetsBtn").addEventListener("click", () => loadTargets().catch(e => toast(e.message, "error")));
    $("previewNotesBtn").addEventListener("click", () => previewNotes().catch(e => toast(e.message, "error")));
    $("addNoteBtn").addEventListener("click", () => addNote().catch(e => toast(e.message, "error")));

    $("reloadBannerBtn").addEventListener("click", () => loadBanner().catch(e => toast(e.message, "error")));
    $("saveBannerBtn").addEventListener("click", () => saveBanner(null).catch(e => toast(e.message, "error")));
    $("disableBannerBtn").addEventListener("click", () => saveBanner(false).catch(e => toast(e.message, "error")));

    $("incidentSubmitBtn").addEventListener("click", () => createIncident().catch(e => toast(e.message, "error")));
    $("incidentReloadBtn").addEventListener("click", () => loadIncidentList().catch(e => toast(e.message, "error")));
    $("addUpdateBtn").addEventListener("click", () => addUpdate().catch(e => toast(e.message, "error")));

    // ---------- Init ----------
    (async function init(){
      if (!getSessionToken()) {
        window.location.href = "/login";
        return;
      }

      try { await loadTargets(); }
      catch(e){ console.error(e); toast("Failed to load targets: " + e.message, "error"); }

      try { await loadBanner(); }
      catch(e){ console.error(e); toast("Failed to load banner: " + e.message, "error"); }

      try { await loadIncidentList(); }
      catch(e){ console.error(e); }
    })();
  </script>
</body>
</html>