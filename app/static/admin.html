<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EWS Monitoring — Admin</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #111833;
      --line: rgba(255,255,255,.08);
      --text: #e8ecff;
      --muted: #a9b2d6;
      --ok: #31d07f;
      --bad: #ff4d5e;
      --warn: #ffcc66;
    }
    * { box-sizing: border-box; }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      padding: 24px;
      max-width: 980px;
      min-height: 100vh;
      background: linear-gradient(180deg, #070a14 0%, var(--bg) 100%);
      color: var(--text);
    }
    h1 { margin: 0 0 8px; font-size: 22px; font-weight: 700; }
    .muted { color: var(--muted); font-size: 13px; }
    .muted code { background: rgba(255,255,255,.08); padding: 2px 6px; border-radius: 6px; font-size: 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card {
      background: linear-gradient(180deg, rgba(17,24,51,.95) 0%, rgba(15,22,48,.85) 100%);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 18px;
    }
    .card h2 { margin: 0 0 12px; font-size: 16px; font-weight: 700; }
    label { display: block; font-size: 13px; color: var(--muted); margin: 12px 0 6px; }
    label:first-of-type { margin-top: 0; }
    input[type="text"], input[type="password"], textarea, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(25,34,72,.4);
      color: var(--text);
      font-size: 14px;
    }
    input::placeholder, textarea::placeholder { color: var(--muted); opacity: .8; }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: rgba(124,156,255,.5);
      box-shadow: 0 0 0 2px rgba(124,156,255,.15);
    }
    select { cursor: pointer; }
    textarea { min-height: 90px; resize: vertical; }
    .btns { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(25,34,72,.7);
      color: var(--text);
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
    }
    button:hover { background: rgba(25,34,72,.9); }
    button.secondary { background: rgba(25,34,72,.4); }
    button.danger { background: rgba(255,77,94,.25); border-color: var(--bad); color: #ff8a94; }
    button.danger:hover { background: rgba(255,77,94,.35); }
    .pill {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid var(--line);
      background: rgba(25,34,72,.35);
    }
    .pill.ok { background: rgba(49,208,127,.15); border-color: var(--ok); color: var(--ok); }
    .pill.bad { background: rgba(255,77,94,.15); border-color: var(--bad); color: var(--bad); }
    /* Preview areas (no JSON) */
    .preview-box {
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.2);
      font-size: 13px;
      color: var(--text);
    }
    .preview-box .preview-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: .05em; margin-bottom: 8px; }
    .preview-box .banner-preview {
      white-space: pre-wrap;
      word-break: break-word;
      font-weight: 600;
    }
    .preview-box .banner-preview.empty { color: var(--muted); font-style: italic; font-weight: normal; }
    .notes-list-preview { display: flex; flex-direction: column; gap: 10px; }
    .notes-list-preview .note-item {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .notes-list-preview .note-item .note-title { font-weight: 600; font-size: 13px; margin-bottom: 4px; }
    .notes-list-preview .note-item .note-body { font-size: 12px; color: var(--muted); white-space: pre-wrap; word-break: break-word; }
    .notes-list-preview .empty { color: var(--muted); font-style: italic; font-size: 13px; }
    @media (max-width: 720px) { .row { grid-template-columns: 1fr; } }
  </style>
</head>

<body>
  <h1>EWS Monitoring — Admin</h1>
  <div class="muted">Uses <code>x-admin-key</code> header. Key is stored only in this browser (localStorage).</div>

  <div class="card" style="margin-top:20px;">
    <h2>Admin Key</h2>
    <label for="adminKey">x-admin-key</label>
    <input id="adminKey" type="password" placeholder="Paste ADMIN_KEY here" />
    <div class="btns">
      <button id="saveKeyBtn">Save key</button>
      <button id="clearKeyBtn" class="secondary" type="button">Clear</button>
    </div>
  </div>

  <div class="row" style="margin-top:20px;">
    <!-- Banner -->
    <div class="card">
      <h2>Banner</h2>
      <div id="bannerStatus" class="pill">Loading…</div>

      <label>
        <input type="checkbox" id="bannerEnabled" />
        Enabled
      </label>

      <label for="bannerType">Type</label>
      <select id="bannerType">
        <option value="info">info</option>
        <option value="maintenance">maintenance</option>
        <option value="warning">warning</option>
        <option value="incident">incident</option>
      </select>

      <label for="bannerMessage">Message (line breaks are shown on the dashboard)</label>
      <textarea id="bannerMessage" placeholder="Planned maintenance Sunday 2:00–3:00 AM ET"></textarea>

      <label for="bannerStartsAt">Starts at (ISO, optional)</label>
      <input id="bannerStartsAt" type="text" placeholder="2026-02-23T02:00:00-05:00">

      <label for="bannerEndsAt">Ends at (ISO, optional)</label>
      <input id="bannerEndsAt" type="text" placeholder="2026-02-23T03:00:00-05:00">

      <div class="btns">
        <button id="saveBannerBtn">Save banner</button>
        <button id="disableBannerBtn" class="danger" type="button">Disable banner</button>
        <button id="reloadBannerBtn" class="secondary" type="button">Reload</button>
      </div>

      <div class="preview-box">
        <div class="preview-label">Preview (as shown on dashboard)</div>
        <div id="bannerPreview" class="banner-preview empty">No message yet.</div>
      </div>
    </div>

    <!-- Notes -->
    <div class="card">
      <h2>Per-API Notes</h2>
      <div class="muted">Pick a target, add a note, then preview below.</div>

      <label for="targetSelect">Target</label>
      <select id="targetSelect"></select>

      <label for="noteTitle">Title</label>
      <input id="noteTitle" type="text" placeholder="Maintenance window" />

      <label for="noteBody">Body</label>
      <textarea id="noteBody" placeholder="Planned maintenance Sunday 2–3 AM ET. Some requests may time out."></textarea>

      <div class="btns">
        <button id="addNoteBtn">Add note</button>
        <button id="previewNotesBtn" class="secondary" type="button">Preview notes</button>
        <button id="reloadTargetsBtn" class="secondary" type="button">Reload targets</button>
      </div>

      <div class="preview-box">
        <div class="preview-label">Notes for selected target</div>
        <div id="notesPreview" class="notes-list-preview"><span class="empty">Select a target and click Preview notes.</span></div>
      </div>
    </div>
  </div>

  <script>
    const API = {
      SUMMARY_GET: "/api/summary",
      NOTICES_GET: "/api/notices",
      BANNER_PUT: "/api/admin/notices/banner",
      NOTE_ADD_POST: (id) => `/api/admin/targets/${encodeURIComponent(id)}/notes`,
      NOTES_GET: (id) => `/api/targets/${encodeURIComponent(id)}/notes`,
    };

    function $(id){ return document.getElementById(id); }

    function getAdminKey(){
      return localStorage.getItem("ewsmon_admin_key") || "";
    }
    function setAdminKey(v){
      localStorage.setItem("ewsmon_admin_key", v);
    }
    function clearAdminKey(){
      localStorage.removeItem("ewsmon_admin_key");
    }

    async function fetchJson(url, opts={}){
      const res = await fetch(url, {
        cache: "no-store",
        headers: { "Accept":"application/json", ...(opts.headers || {}) },
        ...opts
      });
      if (!res.ok){
        const txt = await res.text().catch(() => "");
        throw new Error(`${url} -> ${res.status} ${txt}`);
      }
      return await res.json();
    }

    function adminHeaders(extra={}){
      const key = getAdminKey();
      return {
        "x-admin-key": key,
        ...extra
      };
    }

    function setPill(el, text, kind){
      el.textContent = text;
      el.className = "pill " + (kind || "");
    }

    // ---------- Targets ----------
    async function loadTargets(){
      const sel = $("targetSelect");
      sel.innerHTML = `<option>Loading…</option>`;
      const data = await fetchJson(API.SUMMARY_GET);
      const items = Array.isArray(data) ? data : (data.items || []);

      const mapped = items.map(it => ({
        id: it.id ?? it.target_id ?? it.targetId ?? it.service_id,
        name: it.name ?? it.service ?? it.service_name ?? "—"
      })).filter(x => x.id !== undefined && x.id !== null);

      sel.innerHTML = mapped.length
        ? mapped.map(x => `<option value="${String(x.id)}">${String(x.name)} (id: ${String(x.id)})</option>`).join("")
        : `<option value="">No targets found (summary missing id)</option>`;
    }

    // ---------- Banner ----------
    function updateBannerPreview(){
      const msg = $("bannerMessage").value.trim();
      const el = $("bannerPreview");
      el.textContent = msg || "";
      el.classList.toggle("empty", !msg);
      if (!msg) el.textContent = "No message yet.";
    }

    async function loadBanner(){
      const raw = await fetchJson(API.NOTICES_GET).catch(() => null);
      const b = raw?.banner || null;
      if (!b){
        setPill($("bannerStatus"), "No banner object found", "bad");
        $("bannerPreview").textContent = "No message yet.";
        $("bannerPreview").classList.add("empty");
        return;
      }

      $("bannerEnabled").checked = !!b.enabled;
      $("bannerType").value = b.type || "info";
      $("bannerMessage").value = b.message || "";
      $("bannerStartsAt").value = b.starts_at || "";
      $("bannerEndsAt").value = b.ends_at || "";

      setPill($("bannerStatus"), b.enabled ? `Enabled (${b.type || "info"})` : "Disabled", b.enabled ? "ok" : "");
      const el = $("bannerPreview");
      el.textContent = b.message || "";
      el.classList.toggle("empty", !b.message);
      if (!b.message) el.textContent = "No message yet.";
    }

    async function saveBanner(enabledOverride=null){
      const enabled = (enabledOverride !== null) ? enabledOverride : $("bannerEnabled").checked;

      const payload = {
        enabled,
        notice_type: $("bannerType").value,
        message: $("bannerMessage").value,
        starts_at: $("bannerStartsAt").value || null,
        ends_at: $("bannerEndsAt").value || null
      };

      await fetchJson(API.BANNER_PUT, {
        method: "PUT",
        headers: adminHeaders({ "Content-Type":"application/json" }),
        body: JSON.stringify(payload)
      });

      await loadBanner();
      alert(enabled ? "Banner saved ✅" : "Banner disabled ✅");
    }

    $("bannerMessage").addEventListener("input", updateBannerPreview);

    // ---------- Notes ----------
    async function addNote(){
      const targetId = $("targetSelect").value;
      if (!targetId){
        alert("Select a target first.");
        return;
      }

      const title = $("noteTitle").value.trim();
      const body = $("noteBody").value.trim();
      if (!title || !body){
        alert("Title + body are required.");
        return;
      }

      const payload = { title, body };

      await fetchJson(API.NOTE_ADD_POST(targetId), {
        method: "POST",
        headers: adminHeaders({ "Content-Type":"application/json" }),
        body: JSON.stringify(payload)
      });

      $("noteTitle").value = "";
      $("noteBody").value = "";
      alert("Note added ✅");
      await previewNotes();
    }

    function escapeHtml(s){
      const t = document.createTextNode(String(s ?? ""));
      const div = document.createElement("div");
      div.appendChild(t);
      return div.innerHTML;
    }

    async function previewNotes(){
      const container = $("notesPreview");
      const targetId = $("targetSelect").value;
      if (!targetId){
        container.innerHTML = "<span class=\"empty\">Select a target and click Preview notes.</span>";
        return;
      }
      const data = await fetchJson(API.NOTES_GET(targetId));
      const items = data?.items ?? (Array.isArray(data) ? data : []);
      if (!items.length){
        container.innerHTML = "<span class=\"empty\">No notes for this target.</span>";
        return;
      }
      container.innerHTML = items.map(n => {
        const title = escapeHtml(n.title ?? "");
        const body = escapeHtml(n.body ?? n.note ?? "").replace(/\n/g, "<br>");
        const date = n.created_at ? new Date(n.created_at).toLocaleString() : "";
        return `<div class="note-item"><div class="note-title">${title}</div><div class="note-body">${body}</div>${date ? `<div class="muted" style="font-size:11px;margin-top:6px;">${escapeHtml(date)}</div>` : ""}</div>`;
      }).join("");
    }

    // ---------- Wire up ----------
    $("saveKeyBtn").addEventListener("click", () => {
      setAdminKey($("adminKey").value.trim());
      alert("Saved ✅");
    });
    $("clearKeyBtn").addEventListener("click", () => {
      clearAdminKey();
      $("adminKey").value = "";
      alert("Cleared ✅");
    });

    $("reloadTargetsBtn").addEventListener("click", () => loadTargets().catch(e => alert(e.message)));
    $("previewNotesBtn").addEventListener("click", () => previewNotes().catch(e => alert(e.message)));
    $("addNoteBtn").addEventListener("click", () => addNote().catch(e => alert(e.message)));

    $("reloadBannerBtn").addEventListener("click", () => loadBanner().catch(e => alert(e.message)));
    $("saveBannerBtn").addEventListener("click", () => saveBanner(null).catch(e => alert(e.message)));
    $("disableBannerBtn").addEventListener("click", () => saveBanner(false).catch(e => alert(e.message)));

    // ---------- Init ----------
    (async function init(){
      $("adminKey").value = getAdminKey();

      try { await loadTargets(); }
      catch(e){ console.error(e); alert("Failed to load targets: " + e.message); }

      try { await loadBanner(); }
      catch(e){ console.error(e); alert("Failed to load banner: " + e.message); }
    })();
  </script>
</body>
</html>